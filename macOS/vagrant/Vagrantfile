podmanBox = ENV["VAGRANT_PODMAN_BOX"] || "fedora/35-cloud-base"
windowsBox = ENV["VAGRANT_WINDOWS_BOX"] || "gusztavvargadr/windows-11"

Vagrant.configure("2") do |config|
  config.env.enable
  config.timezone.value = :host
  config.vm.synced_folder ".", "/vagrant", disabled: true

  config.vm.define "podman" do |podman|
    podman.vm.box = podmanBox

    podman.vm.provider "virtualbox" do |vb|
      vb.name = "vagrant-podman"
      vb.memory = "1024"
    end

    podman.vm.network "private_network", ip: "192.168.56.100"

    podman.vm.provision "shell", inline: <<-SHELL
      dnf install -y virtualbox-guest-additions
      dnf install -y podman

      groupadd -f -r podman

      #systemctl edit podman.socket
      mkdir -p /etc/systemd/system/podman.socket.d
      cat >/etc/systemd/system/podman.socket.d/override.conf <<EOF
[Socket]
SocketMode=0660
SocketUser=root
SocketGroup=podman
EOF
      systemctl daemon-reload
      echo "d /run/podman 0770 root podman" > /etc/tmpfiles.d/podman.conf
      sudo systemd-tmpfiles --create

      systemctl enable podman.socket
      systemctl start podman.socket

      usermod -aG podman $SUDO_USER
    SHELL
  end

  config.vm.define "windows" do |windows|
    windows.vm.box = windowsBox

    windows.vm.provider "virtualbox" do |vb|
      vb.name = "vagrant-windows"
      vb.memory = "4096"
    end

    windows.vm.network "private_network", ip: "192.168.56.200"
  end
end
